# Administraci√≥n de dominios:
- Estructura grupo de trabajo.
- Estructura cliente-servidor.
- Protocolo LDAP.
- Estructura l√≥gica del directorio activo (DA):
  - Concepto de dominio. Subdominios.
  - Unidades organizativas. Objetos.
  - √Årboles y bosques.
  - Cat√°logo global. Esquema.
  - Funciones de los maestros de operaciones.
- Estructura f√≠sica del DA:
  - Concepto de sitio (Site). Optimizaci√≥n del tr√°fico de red.
- Configurar la replicaci√≥n entre Sites.
- Requisitos necesarios para montar un dominio.
- Administraci√≥n de cuentas. Cuentas predeterminadas.
- Contrase√±as. Bloqueos de cuenta.
- Cuentas de usuarios y equipos.
- Perfiles m√≥viles y obligatorios.
- Carpetas personales.
- Plantillas de usuario. Variables de entorno.
- Restringir el inicio de sesi√≥n de una cuenta:
  - A ciertas horas y d√≠as.
  - En determinados ordenadores.
- Scripts de inicio de sesi√≥n.
- Administraci√≥n de grupos. Tipos. Estrategias de anidamiento. Grupos predeterminados.
- Unidades Organizativas (UO).
  - Estrategias de administraci√≥n.
  
------------------------

# Teor√≠a
* https://www.jesusninoc.com/09/01/tecnico-superior-en-administracion-de-sistemas-informaticos-en-red/#Administracion_de_dominios_Implantacion_de_sistemas_operativos

--------------------------

# Windows Server
## Roles para instalar
https://play.google.com/books/reader?id=A9vJAwAAQBAJ&hl=en_US&pg=GBS.PA16
## This is not your fathers Windows Server: Setting up Server Core with PowerShell
https://sid-500.com/2017/07/11/setting-up-windows-server-core-with-powershell/

## Step-By-Step: Setting up Active Directory in Windows Server 2016
https://blogs.technet.microsoft.com/canitpro/2017/02/22/step-by-step-setting-up-active-directory-in-windows-server-2016/

------------------

# Ejercicios de introducci√≥n (pruebas de concepto)
* https://www.jesusninoc.com/02/19/ejercicios-de-powershell-enviar-el-codigo-de-una-pagina-web-mediante-udp-entre-un-cliente-y-un-servidor-despues-de-realizar-una-comprobacion-del-nombre-de-usuario/
* https://www.jesusninoc.com/02/19/ejercicios-de-powershell-uso-y-manipulacion-de-credenciales/
* https://www.jesusninoc.com/02/19/ejercicios-de-powershell-enviar-credenciales-entre-un-cliente-y-un-servidor-por-udp/
* https://www.jesusninoc.com/02/19/ejercicios-de-powershell-enviar-credenciales-entre-un-cliente-y-un-servidor-por-udp-y-ejecutar-una-aplicacion-en-el-servidor-con-dichos-credenciales/

------------------

# Active Directory ‚Äì Windows Server
http://www.developandsys.es/active-directory-windows-server/

# AD Overview Graphical Tool: Active Directory Domain Services Section
* https://sid-500.com/2018/03/25/active-directory-domain-services-section-tool-for-active-directory-administrators/

# PowerShell CmdLine Conversion Guide AD
* https://github.com/PrateekKumarSingh/CheatSheets/blob/master/Powershell/PowerShell_CmdLine_Conversion_Guide_AD.pdf

--------------
--------------

# Administraci√≥n de dominios:
- Estructura grupo de trabajo.
- Estructura cliente-servidor.
- Protocolo LDAP.
- Estructura l√≥gica del directorio activo (DA):
  - Concepto de dominio. Subdominios.
  - Unidades organizativas. Objetos.
  - √Årboles y bosques.
  - Cat√°logo global. Esquema.
  - Funciones de los maestros de operaciones.
- Estructura f√≠sica del DA:
  - Concepto de sitio (Site). Optimizaci√≥n del tr√°fico de red.
- Configurar la replicaci√≥n entre Sites.
- Requisitos necesarios para montar un dominio.
- Administraci√≥n de cuentas. Cuentas predeterminadas.
- Contrase√±as. Bloqueos de cuenta.
- Cuentas de usuarios y equipos.
- Perfiles m√≥viles y obligatorios.
- Carpetas personales.
- Plantillas de usuario. Variables de entorno.
- Restringir el inicio de sesi√≥n de una cuenta:
  - A ciertas horas y d√≠as.
  - En determinados ordenadores.
- Scripts de inicio de sesi√≥n.
- Administraci√≥n de grupos. Tipos. Estrategias de anidamiento. Grupos predeterminados.
- Unidades Organizativas (UO).
  - Estrategias de administraci√≥n.
  
------------------------

# Teor√≠a
* https://www.jesusninoc.com/09/01/tecnico-superior-en-administracion-de-sistemas-informaticos-en-red/#Administracion_de_dominios_Implantacion_de_sistemas_operativos

------------------

# DAP, LDAP
LDAP es la abreviatura del Protocolo ligero de acceso a directorios. Como su nombre lo indica, este protocolo es compatible con un servicio de directorio (directorio).

## DAP en OSI
* https://myacordeon.files.wordpress.com/2011/04/osi.gif
* http://www.mitlinx.de/ldap/assets/osi_ldap_dap.gif
* http://www.mitlinx.de/ldap/index.html?http://www.mitlinx.de/ldap/ldap_geschichte.htm

## LDAP Query Basics
https://technet.microsoft.com/es-es/library/aa996205(v=exchg.65).aspx
## Utilizar un filtro LDAP para localizar un usuario
https://www.jesusninoc.com/2018/05/16/utilizar-un-filtro-ldap-para-localizar-un-usuario/
## Active Directory Service Interfaces (ADSI) is a set of COM interfaces used to access the features of directory services from different network providers
https://msdn.microsoft.com/en-us/library/aa772170(v=vs.85).aspx
## List local users (ADSI)
https://www.jesusninoc.com/2016/07/02/list-local-users/
## Posts sobre ADSI
https://www.jesusninoc.com/adsi/
## Using AD Filters with Cmdlets (Part 1)
http://community.idera.com/powershell/powertips/b/tips/posts/using-ad-filters-with-cmdlets-part-1
## Using AD Filters with Cmdlets (Part 2)
http://community.idera.com/powershell/powertips/b/tips/posts/using-ad-filters-with-cmdlets-part-2
## Using AD Filters with Cmdlets (Part 3)
http://community.idera.com/powershell/powertips/b/tips/posts/using-ad-filters-with-cmdlets-part-3
## Using AD Filters with Cmdlets (Part 4)
http://community.idera.com/powershell/powertips/b/tips/posts/using-ad-filters-with-cmdlets-part-4

## 3 ways to search with PowerShell
http://activedirectoryfaq.com/2015/02/ldap-search-powershell-find-ldapobject/

## Active Directory with PowerShell, ADSI, and LDAP
https://www.petri.com/active-directory-powershell-adsi-ldap
## A minimalistic LDAP server in Go
https://github.com/bradleypeabody/godap
## goddi (go dump domain info) dumps Active Directory domain information
https://github.com/NetSPI/goddi/blob/master/conn.go
## A JOURNEY FROM JNDI/LDAP MANIPULATION TO REMOTE CODE EXECUTION DREAM LAND
* https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf
* https://www.youtube.com/watch?v=Y8a5nB-vy78
## GPSCRIPT.EXE ‚Äì ANOTHER LOLBIN TO THE LIST
https://oddvar.moe/2018/04/27/gpscript-exe-another-lolbin-to-the-list/

------------------
------------------

# Comunicaci√≥n entre dos clientes que se validan en un servidor

---------------
---------------

# Situaci√≥n cr√≠tica 1 (resolver la siguiente situaci√≥n con scripts)

## Los hospitales est√°n habilitando zonas nuevas para poder atender a pacientes, eso quiere decir que van a utilizar equipos clientes y servidores, tu tarea es ser capaz de poner odenadores nuevos con la misma configuraci√≥n que tienen los anteriores (usuarios, programas, actualizaciones, carpetas compartidas) y no solo es clonar y ya. Crea un procedimiento con scripts para resolver la situaci√≥n.

## Ejemplos de c√≥mo se puede resolver la situaci√≥n:

- Sacar los usuarios de un equipo y crearlos en otro leyendo de un fichero.
- Ver los programas que hay instalados en un equipo e instalarlos en otro leyendo de un fichero.
- Ver las carpetas compartidas que hay en un equipo y crearlas en otro leyendo de un fichero.

## Ideas que se pueden aplicar:
- Tareas programadas https://github.com/jesusninoc/ClasesISO/blob/master/2020-03-10.md#hyper-v-backup-vms-to-a-shared-folder-with-windows-server-backup-and-a-scheduled-task-
- WMI Query Language https://github.com/jesusninoc/ClasesISO/blob/master/2020-03-10.md#wmi-query-language
- Ejercicios curso MySQL con PowerShell https://www.jesusninoc.com/2017/02/20/ejercicios-curso-mysql-con-powershell/
- Leer un usuario desde un servidor web (HTML, XML, JSON) crearlo y meterlo en el grupo de administradores (no te olvides del password).
- Detectar mediante una funci√≥n que el usuario pertenece al grupo de administradores.
- Intentar utilizar las credenciales de un usuario y verificar que funciona (guarda en un fichero la captura).
- Expresiones regulares https://github.com/jesusninoc/ClasesISO/blob/master/2020-03-13.md#expresiones-regulares

-----------------

# Soluci√≥n a la situaci√≥n cr√≠tica 1

## Seleccionar usuarios que empiezan por una letra (con una expresi√≥n regular)
* https://www.jesusninoc.com/04/12/ejercicios-de-powershell-seleccionar-usuarios-que-empiezan-por-una-letra-con-una-expresion-regular/

## Restaurar usuarios creados anteriormente
* https://www.jesusninoc.com/03/13/ejercicios-de-powershell-restaurar-usuarios-que-se-han-creado-anteriormente-se-almacenan-en-un-fichero-y-se-vuelven-a-crear/

## Ver los progrmas que hay instalados en un equipo e instalarlos en otro leyendo de un fichero
* https://www.jesusninoc.com/03/16/ejercicios-de-powershell-ver-los-programas-que-hay-instalados-en-un-equipo-e-instalarlos-en-otro-guardar-el-nombre-de-los-programas-en-un-fichero/

## Mapear unidades
* https://www.jesusninoc.com/03/17/ejercicios-de-powershell-mapear-varias-unidades-que-se-encuentran-en-un-fichero/
* https://www.jesusninoc.com/02/16/ejercicios-de-powershell-mapear-varios-recursos-unidades-creando-tambien-las-carpetas-y-compartiendo-leyendo-de-un-fichero-el-nombre-el-mismo-nombre-para-todas-las-operaciones-de-la-carpeta-que/

## Poner bonito
* https://www.jesusninoc.com/02/25/ejercicios-de-powershell-crear-un-menu-sencillo/

# Soluci√≥n a la situaci√≥n cr√≠tica 2 (muy avanzada)

## Instalar software en cualquier equipo de la red desde PowerShell leyendo desde un archivo la informaci√≥n para instalar utilizando credenciales almacenados (soluci√≥n de Diego A.)
* https://github.com/jesusninoc/ClasesISO/blob/master/2019-01-09.md#instalar-software-en-cualquier-equipo-de-la-red-desde-powershell-leyendo-desde-un-archivo-la-informaci%C3%B3n-para-instalar-utilizando-credenciales-almacenados-soluci%C3%B3n-de-diego-a

-----------
-----------

# Situaci√≥n cr√≠tica 2 (resolver la siguiente situaci√≥n con scripts)

## Dentro de una empresa se est√° ejecutando una aplicaci√≥n de forma an√≥mala, utiliza todo lo que sabes para crear funciones en un script que permitan detectar la aplicaci√≥n.

### Ideas que se pueden aplicar:
- ¬øC√≥mo detectar que se est√° ejecutando un proceso? https://github.com/jesusninoc/ClasesISO/blob/master/2020-03-10.md#c%C3%B3mo-detectar-que-se-est%C3%A1-ejecutando-un-proceso
- Mostrar un mensaje en PowerShell cuando se ejecuta y se para un programa https://github.com/jesusninoc/ClasesISO/blob/master/2020-03-10.md#mostrar-un-mensaje-en-powershell-cuando-se-ejecuta-y-para-un-programa

-----------------

# Soluci√≥n a la situaci√≥n cr√≠tica 2

## Vamos a tener en cuenta:
- Un proceso que no se comporta como siempre es raro.
- Un proceso que abre muchos hilos es raro.
- Analizar los hilos de un proceso en concreto
- Un proceso que abre muchas comunicaciones es raro.
- Un proceso que consume fuera de normal es raro.
- Un proceso que se activa a una hora extra√±a es raro.
- Un proceso cuya firma ha cambiado es extra√±o.
- Mostrar los procesos que utiliza un controlador

## Scripts para cada uno de los apartados anteriores
* https://www.jesusninoc.com/03/02/ejercicios-de-seguridad-analizar-informacion-sobre-procesos-de-forma-detallada-en-windows-con-powershell/

----------
----------

# Situaci√≥n cr√≠tica 3 (resolver la siguiente situaci√≥n con scripts)

## Crear para cada usuario lo necesario para funcionar en un puesto de trabajo teniendo en cuenta:
- Los usuarios se crean en el Directorio Activo.
- La informaci√≥n se lee de un fichero que cada l√≠nea contiene la siguiente informaci√≥n nombre de usuario, grupo al que pertenece, nombre de carpeta compartida, permisos.
- Cada usuario tiene una carpeta compartida con su nombre (y solo ese usuario tiene permisos tanto NTFS como permisos de compartir).

### Ideas que se pueden aplicar:
- Teor√≠a sobre AD https://github.com/jesusninoc/ClasesISO/blob/master/2020-03-18.md
- Crear usuarios en AD https://github.com/jesusninoc/ClasesASO/blob/master/2019-09-24.md#crear-en-ad-usuarios-y-ou-leyendo-de-un-fichero
- Crear recurso compartido https://www.jesusninoc.com/02/21/crear-un-recurso-compartido/

-----------------

# Soluci√≥n a la situaci√≥n cr√≠tica 3
- Soluci√≥n de Pablo https://github.com/PabloQueipo/ISO/blob/master/19%20MARZO

-------------
-------------

# Situaci√≥n cr√≠tica 4 (resolver la siguiente situaci√≥n con scripts)

## Crear una estructa en el dominio del Directorio Activo con los departamentos de un hospital, junto con usuarios que se leen de un fichero (crear unidades organizativas y meter dentro usuarios).

### Utilizar los siguientes scripts como ayuda:
- https://github.com/jesusninoc/ClasesISO/blob/master/2019-04-03.md#crear-mediante-scripts-una-estructura-de-dominio-parecida-a-la-que-tenemos-en-el-centro-soluci%C3%B3n-alejandro-aracil
- https://github.com/jesusninoc/ClasesISO/blob/master/2019-04-03.md#otra-soluci%C3%B3n-con-ejemplos-de-creaci%C3%B3n-de-pol%C3%ADticas-de-grupo-ignacio-barranquero

-----------------

# Soluci√≥n a la situaci√≥n cr√≠tica 4 (soluci√≥n de Pablo)
* https://github.com/PabloQueipo/ISO/blob/master/24%20MARZO%202020.md

--------------
--------------

# Administraci√≥n de dominios:
- Estructura grupo de trabajo.
- Estructura cliente-servidor.
- Protocolo LDAP.
- Estructura l√≥gica del directorio activo (DA):
  - Concepto de dominio. Subdominios.
  - Unidades organizativas. Objetos.
  - √Årboles y bosques.
  - Cat√°logo global. Esquema.
  - Funciones de los maestros de operaciones.
- Estructura f√≠sica del DA:
  - Concepto de sitio (Site). Optimizaci√≥n del tr√°fico de red.
- Configurar la replicaci√≥n entre Sites.
- Requisitos necesarios para montar un dominio.
- Administraci√≥n de cuentas. Cuentas predeterminadas.
- Contrase√±as. Bloqueos de cuenta.
- Cuentas de usuarios y equipos.
- Perfiles m√≥viles y obligatorios.
- Carpetas personales.
- Plantillas de usuario. Variables de entorno.
- Restringir el inicio de sesi√≥n de una cuenta:
  - A ciertas horas y d√≠as.
  - En determinados ordenadores.
- Scripts de inicio de sesi√≥n.
- Administraci√≥n de grupos. Tipos. Estrategias de anidamiento. Grupos predeterminados.
- Unidades Organizativas (UO).
  - Estrategias de administraci√≥n.
  
------------------------

## Ejercicios sobre el AD
* https://www.jesusninoc.com/02/22/ejercicios-de-powershell-crear-una-ou-unidad-organizativa-en-un-directorio-activo/
* https://www.jesusninoc.com/02/22/ejercicios-de-powershell-crea-un-usuario-en-un-directorio-activo/

---------------------

# Credenciales almacenados
* https://www.jesusninoc.com/05/22/sistema-que-permite-almacenar-en-un-fichero-los-credenciales-de-usuario-de-windows-haciendo-una-peticion-a-un-servidor-web-mediante-el-metodo-post-despues-obtener-el-password-en-texto-plano/

-------------------
-------------------

# Administraci√≥n de dominios:
- Estructura grupo de trabajo.
- Estructura cliente-servidor.
- Protocolo LDAP.
- Estructura l√≥gica del directorio activo (DA):
  - Concepto de dominio. Subdominios.
  - Unidades organizativas. Objetos.
  - √Årboles y bosques.
  - Cat√°logo global. Esquema.
  - Funciones de los maestros de operaciones.
- Estructura f√≠sica del DA:
  - Concepto de sitio (Site). Optimizaci√≥n del tr√°fico de red.
- Configurar la replicaci√≥n entre Sites.
- Requisitos necesarios para montar un dominio.
- Administraci√≥n de cuentas. Cuentas predeterminadas.
- Contrase√±as. Bloqueos de cuenta.
- Cuentas de usuarios y equipos.
- Perfiles m√≥viles y obligatorios.
- Carpetas personales.
- Plantillas de usuario. Variables de entorno.
- Restringir el inicio de sesi√≥n de una cuenta:
  - A ciertas horas y d√≠as.
  - En determinados ordenadores.
- Scripts de inicio de sesi√≥n.
- Administraci√≥n de grupos. Tipos. Estrategias de anidamiento. Grupos predeterminados.
- Unidades Organizativas (UO).
  - Estrategias de administraci√≥n.

------------------------

# Teor√≠a
- Servicios de directorio
  - Centralizar
  - Base de datos https://www.jesusninoc.com/12/27/conectar-powershell-con-mysql/
  - X.500
  - DAP
  - LDAP
  - OpenLDAP
  - AD
  - Dominio (√°rbol, bosque). Controlador de dominio. Miembro del servidor. Nivel funcional. Objetos (OU, grupos, usuarios, equipos)
    - √Årbol: red.local y despachos.red.local
    - Bosque: red.local y alumnos.local
    - Controlador de dominio adicional: para tener m√°s de un Controlador de Dominio, simplemente debemos ejecutar el mismo proceso anterior, s√≥lo que en este caso durante el asistente le diremos que es Controlador de Dominio adicional, en un Dominio ya existente. En este caso toda la informaci√≥n de Active Directory que est√° en el primero se replicar√° en el segundo Controlador de Dominio.
    - Diferenciar entre Dominio y Controlador de Dominio: debemos tener en claro la diferencia entre ‚ÄúDominio‚Äù, y ‚ÄúControlador de Dominio‚Äù. Un ‚ÄúDominio‚Äù es un concepto l√≥gico, no es f√≠sico como el ‚ÄúControlador de Dominio‚Äù.
    - Los registros DNS de servicio de Active Directory https://www.elladodelmal.com/2011/05/los-registros-dns-de-servicio-de-active.html
    - Funciones del Cat√°logo Global (Global Catalog): esta funci√≥n es necesaria para que los usuarios normales puedan iniciar sesi√≥n. Aunque recordemos que por omisi√≥n el cliente si puede utiliza ‚Äúcached credentials‚Äù que permiten el acceso local, esto no funcionar√° cuando el usuario quiera acceder a un recurso de red ya que en ese caso el Controlador de Dominio que lo autentica debe poder consultar a un Cat√°logo Global.
    - Replicaci√≥n https://windowserver.wordpress.com/2014/12/02/windows-server-2012-r2-crear-un-dominio-instalacin-y-configuracin-del-segundo-controlador-de-dominio/
  - DNS.

------------------

# Un poco de DNS

------------------

# Ataques DNS

## DNS Spoofing

https://tools.ietf.org/html/rfc5452

When certain steps are taken, it is feasible to "spoof" the current
   deployed majority of resolvers with carefully crafted and timed DNS
   packets.  Once spoofed, a caching server will repeat the data it
   wrongfully accepted, and make its clients contact the wrong, and
   possibly malicious, servers.

   To understand how this process works it is important to know what
   makes a resolver accept a response.

   The following sentence in Section 5.3.3 of [RFC1034] presaged the
   present problem:

     The resolver should be highly paranoid in its parsing of responses.
     It should also check that the response matches the query it sent
     using the ID field in the response.

   DNS data is to be accepted by a resolver if and only if:

   1.  The question section of the reply packet is equivalent to that of
       a question packet currently waiting for a response.

   2.  The ID field of the reply packet matches that of the question
       packet.

   3.  The response comes from the same network address to which the
       question was sent.

   4.  The response comes in on the same network address, including port
       number, from which the question was sent.

   In general, the first response matching these four conditions is
   accepted.
   
   If a third party succeeds in meeting the four conditions before the
   response from the authentic nameserver does so, it is in a position
   to feed a resolver fabricated data.  When it does so, we dub it an
   "attacker", attempting to spoof in fake data.

   All conditions mentioned above can theoretically be met by a third
   party, with the difficulty being a function of the resolver

## Informe sobre ataque en DNS

Enom Central Customers:

I want to inform you that Enom recently became the subject of what appears to be a very sophisticated attack by a group that targets large internet infrastructure companies. Within hours of this attack, we were in contact with federal law enforcement and the affected parties. This attack hijacked the DNS traffic of 4 domains for a very short period of time before we mitigated the situation.

You have not been impacted by this incident and you are not required to take any action to ensure your future security. However, in an effort to continue to strive for transparency and best in class services, I wanted to inform you of this unfortunate situation.

To be clear, no domain names were stolen, and after exhaustive analysis, with the exception of the DNS of the domains specifically targeted, we do not have any evidence or reason to believe that these malicious actors accessed any customer accounts, customer personal information, or any of Enom‚Äôs secured and encrypted data. Your security is a leading priority at Enom and we continue to work both with federal law enforcement and industry leading security forensic companies to protect your online presence.

I know you trust Enom Central with your domain names and services and we take this responsibility very seriously. We appreciate your business and you have our commitment to continue to do what it takes to protect your assets.

------------------

# Ataques DoS

## Peticiones a recursos
* https://www.jesusninoc.com/03/01/ejercicios-de-seguridad-realizar-peticiones-de-carga-de-forma-indefinida-a-un-sitio-web/

## TCP SYN Flooding Attacks and Common Mitigations
https://tools.ietf.org/html/rfc4987

## XERXES ‚Äì Most Powerful Tool For DoS Attack using Kali Linux
* https://gbhackers.com/xerxes-kali-linux-tutorial/
* https://github.com/zanyarjamal/xerxes

## Un poco DDoS y herramientas para detener los ataques
https://www.elevenpaths.com/es/noticias-y-eventos/elevenpaths-talks/un-poco-ddos-y-herramientas-para-detener-los-ataques/index.html

## LOIC
### Low Orbit Ion Cannon
An open source network stress tool, written in C#. Based on Praetox's LOIC project. USE ON YOUR OWN RISK. WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES.

https://github.com/NewEraCracker/LOIC

### Java LOIC. Low Orbit Ion Cannon. 
A Java based network stress testing application

https://www.kitploit.com/2015/05/java-loic-low-orbit-ion-cannon-java.html

## Fail2ban
Fail2ban scans log files (e.g. /var/log/apache/error_log) and bans IPs that show the malicious signs -- too many password failures, seeking for exploits, etc. Generally Fail2Ban is then used to update firewall rules to reject the IP addresses for a specified amount of time, although any arbitrary other action (e.g. sending an email) could also be configured. Out of the box Fail2Ban comes with filters for various services (apache, courier, ssh, etc).

https://www.fail2ban.org/wiki/index.php/Main_Page

## How To Protect SSH and Apache Using Fail2Ban on Ubuntu Linux
https://blog.rapid7.com/2017/02/13/how-to-protect-ssh-and-apache-using-fail2ban-on-ubuntu-linux/

---------
---------

# Administraci√≥n de dominios:
- Estructura grupo de trabajo.
- Estructura cliente-servidor.
- Protocolo LDAP.
- Estructura l√≥gica del directorio activo (DA):
  - Concepto de dominio. Subdominios.
  - Unidades organizativas. Objetos.
  - √Årboles y bosques.
  - Cat√°logo global. Esquema.
  - Funciones de los maestros de operaciones.
- Estructura f√≠sica del DA:
  - Concepto de sitio (Site). Optimizaci√≥n del tr√°fico de red.
- Configurar la replicaci√≥n entre Sites.
- Requisitos necesarios para montar un dominio.
- Administraci√≥n de cuentas. Cuentas predeterminadas.
- Contrase√±as. Bloqueos de cuenta.
- Cuentas de usuarios y equipos.
- Perfiles m√≥viles y obligatorios.
- Carpetas personales.
- Plantillas de usuario. Variables de entorno.
- Restringir el inicio de sesi√≥n de una cuenta:
  - A ciertas horas y d√≠as.
  - En determinados ordenadores.
- Scripts de inicio de sesi√≥n.
- Administraci√≥n de grupos. Tipos. Estrategias de anidamiento. Grupos predeterminados.
- Unidades Organizativas (UO).
  - Estrategias de administraci√≥n.

------------------------

# Teor√≠a
- Servicios de directorio
  - Contrase√±as. Bloqueos de cuenta https://www.jesusninoc.com/contrasenas-seguras-con-powershell/
  - Cuentas de usuarios y equipos https://www.jesusninoc.com/03/05/create-users-add-into-a-group-and-share-directory-with-permissions-in-active-directory/
  - Perfiles m√≥viles y obligatorios.
  - Carpetas personales.
  - Plantillas de usuario. Variables de entorno.
  - Restringir el inicio de sesi√≥n de una cuenta.
  - Scripts de inicio de sesi√≥n.

------------------

# Ejercicio
## Hay un problema de seguridad en el hospital, un ransomware ha sido capaz de crear usuarios (no administradores) que pueden crear otros usuarios mediante un script que se ha ejecutado (haciendo clicks) en la cuenta del administrador. Explica mediante capturas y scripts c√≥mo se ha realizado (no te agobies, haz lo que sepas).

### Pasos (por ejemplo):
- Crear usuarios leyendo de un fichero
- Script gr√°fico que hace clicks en determinadas zonas de la configuraci√≥n de Windows Server
- Dejar el script programado mediante una GPO

### Ayuda
#### Crear OU, usuarios, buscar
* https://www.jesusninoc.com/02/22/ejercicios-de-powershell-crea-un-usuario-en-un-directorio-activo/
* https://www.jesusninoc.com/02/22/ejercicios-de-powershell-crear-una-ou-unidad-organizativa-en-un-directorio-activo/
* https://www.jesusninoc.com/05/16/utilizar-un-filtro-ldap-para-localizar-un-usuario/
* https://www.jesusninoc.com/07/05/utilizar-un-filtro-ldap-para-verificar-la-hora-del-ultimo-inicio-de-sesion-de-los-usuarios-del-active-directory/

#### M√°s ayuda
* https://github.com/jesusninoc/ClasesASO/blob/master/2019-09-24.md#crear-usuarios-leyendo-desde-un-fichero-explicar-fichero-y-bucle-foreach
* https://github.com/jesusninoc/ClasesASO/blob/master/2019-09-25.md#utilizar-un-filtro-ldap-para-localizar-un-usuario
* https://github.com/jesusninoc/ClasesASO/blob/master/2019-09-25.md#utilizar-un-filtro-ldap-para-verificar-la-hora-del-%C3%BAltimo-inicio-de-sesi%C3%B3n-de-los-usuarios-del-active-directory
* https://github.com/jesusninoc/ClasesASO/blob/master/2019-09-27.md#crear-usuarios-grupos-ous-y-todo-lo-que-quieras-leyendo-de-una-p%C3%A1gina-web
* https://github.com/jesusninoc/ClasesASO/blob/master/2019-10-01.md#instalaci%C3%B3n-configuraci%C3%B3n-objetos-relaciones-de-confianza-gpos-rodc-dc-secundario
* https://github.com/jesusninoc/ClasesASO/blob/master/2019-10-02.md#funci%C3%B3n-comprobar-con-filtro-ldap-soluci%C3%B3n-de-enrique-carreras

-------------
-------------

# Tareas liberatorias
- Poner en bonito el siguiente conjunto de scripts de la soluci√≥n a la tarea 1: https://github.com/jesusninoc/ClasesISO/blob/master/2021-02-22.md#soluci%C3%B3n-a-la-situaci%C3%B3n-cr%C3%ADtica-1
- Crear un segundo controlador de dominio: https://windowserver.wordpress.com/2014/12/02/windows-server-2012-r2-crear-un-dominio-instalacin-y-configuracin-del-segundo-controlador-de-dominio/

---------------
---------------

# Caso para resolver
* https://github.com/jesusninoc/ClasesISO/blob/master/2021-02-22.md#situaci%C3%B3n-cr%C3%ADtica-1-resolver-la-siguiente-situaci%C3%B3n-con-scripts

--------------
--------------

# Administraci√≥n de dominios:
- Estructura grupo de trabajo.
- Estructura cliente-servidor.
- Protocolo LDAP.
- Estructura l√≥gica del directorio activo (DA):
  - Concepto de dominio. Subdominios.
  - Unidades organizativas. Objetos.
  - √Årboles y bosques.
  - Cat√°logo global. Esquema.
  - Funciones de los maestros de operaciones.
- Estructura f√≠sica del DA:
  - Concepto de sitio (Site). Optimizaci√≥n del tr√°fico de red.
- Configurar la replicaci√≥n entre Sites.
- Requisitos necesarios para montar un dominio.
- Administraci√≥n de cuentas. Cuentas predeterminadas.
- Contrase√±as. Bloqueos de cuenta.
- Cuentas de usuarios y equipos.
- Perfiles m√≥viles y obligatorios.
- Carpetas personales.
- Plantillas de usuario. Variables de entorno.
- Restringir el inicio de sesi√≥n de una cuenta:
  - A ciertas horas y d√≠as.
  - En determinados ordenadores.
- Scripts de inicio de sesi√≥n.
- Administraci√≥n de grupos. Tipos. Estrategias de anidamiento. Grupos predeterminados.
- Unidades Organizativas (UO).
  - Estrategias de administraci√≥n.

------------------------

# Teor√≠a
- Servicios de directorio
  - Perfiles m√≥viles y obligatorios https://docs.microsoft.com/es-es/windows/client-management/mandatory-user-profile
  - Unidades Organizativas (UO).
    - Estrategias de administraci√≥n.
  
------------------

# Administraci√≥n del acceso al dominio:
- Equipos del dominio.
- Permisos y derechos.
- Delegaci√≥n de permisos / autoridad.
  - Asistente para la delegaci√≥n de control.
  - Herramientas de l√≠nea de comandos: dsacls.exe y dsrevoke.exe.	ü§¶
- Listas de control de acceso.

# Joining Computers

## Tener en cuenta
 - IP fija
 - ping
 - DNS
 - EQUIPO EN DOMINIO
 - QUE SE VEA EN EL AD
 - CONFIGURAR LA DIRECTIVA
 - PROBARLO
 - gpupdate /force
 - GPRESULT /z

## Joining Computers to a Domain (PowerShell)
http://community.idera.com/powershell/powertips/b/tips/posts/joining-computers-to-a-domain

## Joining Computers to a Domain (GUI)
 
# Ejercicios

## Ejercicios sin scripts
- INSTALAR UN EQUIPO Y METERLO EN EL DOMINIO

## Ejercicios con scripts
- Acceso remoto desde Powershell https://github.com/jesusninoc/ClasesSeguridad/blob/master/2019-01-16.md

------------
------------

# Administraci√≥n del acceso al dominio:
- Equipos del dominio.
- Permisos y derechos.
- Delegaci√≥n de permisos / autoridad.
  - Asistente para la delegaci√≥n de control.
  - Herramientas de l√≠nea de comandos: dsacls.exe y dsrevoke.exe.	ü§¶
- Listas de control de acceso.

# Joining Computers

## Tener en cuenta
 - IP fija
 - ping
 - DNS
 - EQUIPO EN DOMINIO
 - QUE SE VEA EN EL AD
 - CONFIGURAR LA DIRECTIVA
 - PROBARLO
 - gpupdate /force
 - GPRESULT /z

## Joining Computers to a Domain (PowerShell)
http://community.idera.com/powershell/powertips/b/tips/posts/joining-computers-to-a-domain

## Joining Computers to a Domain (GUI)
 
# Ejercicios

## Ejercicios sin scripts
- INSTALAR UN EQUIPO Y METERLO EN EL DOMINIO

## Ejercicios con scripts
- Acceso remoto desde Powershell https://github.com/jesusninoc/ClasesSeguridad/blob/master/2019-01-16.md

-----------
-----------

# Repaso de casos
* https://github.com/jesusninoc/ClasesISO/blob/master/2021-02-22.md#situaci%C3%B3n-cr%C3%ADtica-3-resolver-la-siguiente-situaci%C3%B3n-con-scripts
* https://github.com/jesusninoc/ClasesISO/blob/master/2021-02-22.md#situaci%C3%B3n-cr%C3%ADtica-4-resolver-la-siguiente-situaci%C3%B3n-con-scripts

------------------------------------
------------------------------------

# Administraci√≥n del acceso al dominio:
- Equipos del dominio.
- Permisos y derechos.
- Delegaci√≥n de permisos / autoridad.
  - Asistente para la delegaci√≥n de control.
  - Herramientas de l√≠nea de comandos: dsacls.exe y dsrevoke.exe.	ü§¶
- Listas de control de acceso.

## Tener en cuenta
 - IP fija
 - ping
 - DNS
 - EQUIPO EN DOMINIO
 - QUE SE VEA EN EL AD
 - CONFIGURAR LA DIRECTIVA
 - PROBARLO
 - gpupdate /force
 - GPRESULT /z

# Listas de control de acceso
## Permisos desde PowerShell
* https://www.jesusninoc.com/01/23/clonar-permisos-ntfs/
* https://www.jesusninoc.com/08/19/anadir-permiso-ntfs-a-una-carpeta/
* https://www.jesusninoc.com/03/30/eliminar-permisos-explicitos/

# Ejercicios
## Ejercicios con scripts
- Crear un usuario en el AD, delegar la tarea de "Unir un equipo al dominio" a ese usuario y ejecutar el script para que el equipo se meta en el dominio (desde el equipo que queremos meter en el dominio)
  - Local
  - Remoto
    * http://community.idera.com/powershell/powertips/b/tips/posts/joining-computers-to-a-domain

# Pr√°ctica compleja
## A√±adir un controlador de dominio adicional
  - Controlador de dominio adicional: Para tener m√°s de un Controlador de Dominio, simplemente debemos ejecutar el mismo proceso anterior, s√≥lo que en este caso durante el asistente le diremos que es Controlador de Dominio adicional, en un Dominio ya existente. En este caso toda la informaci√≥n de Active Directory que est√° en el primero se replicar√° en el segundo Controlador de Dominio
  - Replicaci√≥n https://windowserver.wordpress.com/2014/12/02/windows-server-2012-r2-crear-un-dominio-instalacin-y-configuracin-del-segundo-controlador-de-dominio/

------------------
------------------

# Administraci√≥n del acceso al dominio:
- Equipos del dominio.
- Permisos y derechos.
- Delegaci√≥n de permisos / autoridad.
  - Asistente para la delegaci√≥n de control.
  - Herramientas de l√≠nea de comandos: dsacls.exe y dsrevoke.exe.	ü§¶
- Listas de control de acceso.

## Tener en cuenta
 - IP fija
 - ping
 - DNS
 - EQUIPO EN DOMINIO
 - QUE SE VEA EN EL AD
 - CONFIGURAR LA DIRECTIVA
 - PROBARLO
 - gpupdate /force
 - GPRESULT /z

# Usuarios y grupos
## A√±adir usuarios y grupos desde el AD (GPO)
* https://www.cesarherrada.com/2014/07/que-son-y-para-que-sirven-los-grupos-restringidos.html

# Ejercicios
## Ejercicios con scripts
- Analizar GPO (en remoto y local)
  - Local
    * https://www.jesusninoc.com/05/12/view-group-policy-objects/
    ```PowerShell
      $resulta = gpresult /z
      foreach($lineas in $resulta)
      {
          if($lineas -match "CMD")
          {
              $lineas
          }
      } 
    ```
  - Remoto
    * https://www.jesusninoc.com/04/23/obtener-gpos-objetos-de-directiva-de-grupo-que-no-se-estan-utilizando/
    ```PowerShell
    Get-GPO -All | %{
      $_ | Get-GPOReport -ReportType XML | Select-String "Impedir el acceso al s√≠mbolo del sistema"
    }
    ```
    
------------------
------------------

# Linux scripting
- Vamos por el if

# WSL
* https://www.jesusninoc.com/05/24/interoperabilidad-wsl-con-windows-llamar-a-powershell-desde-ubuntu/

-------------
-------------

# Bloquear lo que diga
- Compartir en el server que se vea en el cliente
- Permisos correctos de NTFS y compartir
- GPO de inicio
- Script de PowerShell que abre un proceso y lee un fichero (todo compartido)

-----------------
-----------------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

-----------------

# Teor√≠a sobre directivas (Registro + tareas programadas + GPO)

## Registro

### EJECUTAR SOLO UNA VEZ UN PROGRAMA AL INICIAR LA SESI√ìN DE UN USUARIO
* https://www.jesusninoc.com/04/13/ejecutar-solo-una-vez-un-programa-al-iniciar-la-sesion-de-un-usuario/
### EjemplosRegistroHardware.ps1
* https://github.com/jesusninoc/PowerShell/blob/master/Registro/EjemplosRegistroHardware.ps1
### ¬øC√ìMO SABER SI ALGUIEN HA UTILIZADO MI ORDENADOR?
* https://www.jesusninoc.com/04/20/como-saber-si-alguien-ha-utilizado-mi-ordenador/
### REGISTRY
* https://www.jesusninoc.com/registry/
### WINDOWS REGISTRY AUDITING CHEAT SHEET - Win 7/Win 2008 or later
* https://static1.squarespace.com/static/552092d5e4b0661088167e5c/t/5a00963153450a8779b23489/1509987890282/Windows+Registry+Auditing+Cheat+Sheet+ver+Nov+2017.pdf

------------
------------

# Prueba sobre carpetas compartidas (NETLOGON)

--------------
--------------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

-----------------

## Tareas programadas

### CREAR TAREAS LEYENDO DE UN JSON
* https://www.jesusninoc.com/03/05/leer-un-fichero-json-desde-powershell/
* https://www.jesusninoc.com/04/19/crear-una-tarea-programada/
* https://www.jesusninoc.com/03/01/tareas-programadas-en-powershell/
* https://www.jesusninoc.com/12/08/crear-una-tarea-programada-en-windows-que-ejecute-un-script-de-powershell-cada-10-minutos-de-forma-indefinida-aunque-el-porcentaje-de-bateria-sea-bajo/

## GPOs

### GPO y registro
* https://www.jesusninoc.com/05/05/exportar-informacion-sobre-una-gpo-en-formato-xml/
### DIRECTIVAS DE GRUPO
* https://www.jesusninoc.com/07/11/11-gestion-del-directorio-activo-nivel-intermedio/#Directivas_de_Grupo
### Aplicaci√≥n GPOs
* http://www.developandsys.es/aplicacion_de_gpos/
### Asignaci√≥n de derechos de usuario
* https://docs.microsoft.com/es-es/windows/security/threat-protection/security-policy-settings/user-rights-assignment
### Orden de aplicaci√≥n de las directivas
- Tener en cuenta:
  - M√°s abajo la √∫ltima que se ejecuta
  - Administrador decide la aplicaci√≥n
- Niveles de aplicaci√≥n:
  - Sitio
  - Dominio
  - GPO

----------------
----------------

# Trabajo sobre Directorio Activo: aplicar GPO
* http://www.developandsys.es/aplicacion_de_gpos/

------------------
------------------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

-----------------

# Ejemplos

## Tener en cuenta
 - IP
 - ping
 - EQUIPO EN DOMINIO
 - QUE SE VEA EN EL AD
 - CONFIGURAR LA DIRECTIVA
 - PROBARLO
 - gpupdate /force
 - GPRESULT /z

## Configurar
- Requisitos de seguridad del sistema y de los datos (CONFIGURAR LA DIRECTIVA DE SEGURIDAD DE BLOQUEO)
- Derechos de usuario (DERECHO QUE OS PAREZCA)
- Directivas de seguridad (DIRECTIVA DE SEGURIDAD PARA TODOS LOS CASOS + DERECHO DE USUARIO):
  - Locales
  - Del controlador de dominio
  - Del dominio.

---------

# Pr√°ctica
- Directivas de grupo:
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n (CREAR SCRIPT QUE ALMACENA LA HORA DE INICIO, APAGADO, INICIO Y CIERRE DE SESI√ìN)

-----------------

# Teor√≠a

## GPOs

### Creaci√≥n y manejo de GPO
http://www.developandsys.es/creacion-manejo-gpo/
### Mapeo de unidades red Windows Server
http://www.developandsys.es/mapeo-unidades-red-windows-server/
### C√≥mo Funcionan las Directivas de Grupo (GPOs)
https://windowserver.wordpress.com/2011/02/10/como-funcionan-las-directivas-de-grupo-gpos/
### Directivas de Grupo (GPO) ‚Äì Herencia, Forzado y Resoluci√≥n de Conflictos
https://windowserver.wordpress.com/2017/07/11/directivas-de-grupo-gpo-herencia-forzado-y-resolucin-de-conflictos/
### Directivas de Grupo (GPO) ‚Äì Filtrado de Seguridad
https://windowserver.wordpress.com/2017/07/11/directivas-de-grupo-gpo-filtrado-de-seguridad/

## Orden de aplicaci√≥n de las directivas
Tener en cuenta:
- M√°s abajo la √∫ltima que se ejecuta
- Administrador decide la aplicaci√≥n
Niveles de aplicaci√≥n:
- Sitio
- Dominio
- GPO

----------
----------

# Repaso
- Acceso remoto
- Github
- PowerShell introducci√≥n
  - Buscar cmdlets
    - https://www.jesusninoc.com/07/01/1-introduccion-a-powershell/
  - WSL
    - https://www.jesusninoc.com/03/26/libro-de-powershell-nivel-avanzado-libro-gratis-de-powershell-tutorial-gratis-de-powershell/
  - AD
    - https://www.jesusninoc.com/07/11/11-gestion-del-directorio-activo-nivel-intermedio/
  - Cmdlets de red
    - https://www.jesusninoc.com/07/09/9-gestion-de-la-red-en-powershell/
  - Pipe
    - https://www.jesusninoc.com/07/01/1-introduccion-a-powershell/#Canalizaciones
  - PSProvider (funciones)
    - https://www.jesusninoc.com/03/17/ejercicios-de-powershell-mapear-varias-unidades-que-se-encuentran-en-un-fichero/
  - PSDrive
    - https://www.jesusninoc.com/get-psdrive/
  - WMI
    - https://www.jesusninoc.com/wmi/
  - Datos
    - https://www.jesusninoc.com/07/02/2-programacion-en-powershell/
  - Scripting
    - https://www.jesusninoc.com/08/03/3-creacion-de-scripts-en-powershell-nivel-avanzado/
  - Funciones complejas
    - https://www.jesusninoc.com/07/02/2-programacion-en-powershell/#Funciones
  - PowerShell remoto
    - https://www.jesusninoc.com/01/10/enable-psremoting/
    - https://www.jesusninoc.com/enter-pssession/
    - https://www.jesusninoc.com/invoke-command/
  - Segundo plano
    - https://www.jesusninoc.com/12/23/crear-un-trabajo-start-job-en-powershell-y-recibirlo-receive-job/
  - Tareas programadas
    - https://www.jesusninoc.com/12/08/crear-una-tarea-programada-en-windows-que-ejecute-un-script-de-powershell-cada-10-minutos-de-forma-indefinida-aunque-el-porcentaje-de-bateria-sea-bajo/
    - https://www.jesusninoc.com/schedule-tasks/
  - Scripts de perfil
    - https://www.jesusninoc.com/07/15/cargar-un-mensaje-de-bienvenida-en-el-perfil-de-usuario-en-powershell/

-------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

-----------------

# Pr√°ctica

## Tener en cuenta
 - IP
 - ping
 - EQUIPO EN DOMINIO
 - QUE SE VEA EN EL AD
 - CONFIGURAR LA DIRECTIVA
 - PROBARLO
 - gpupdate /force
 - GPRESULT /z

## Configurar
- Directivas de grupo:
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n (REALIZAR UN LOG SI EL USUARIO ES usuario1 Y HA INICIADO SESI√ìN) (REALIZAR UN LOG SI EL USUARIO ES usuario1, HA INICIADO SESI√ìN ENTRE LAS 20:00 Y LAS 21:00)
    - https://www.jesusninoc.com/04/15/ejercicios-de-powershell-detectar-si-un-usuario-tiene-iniciada-la-sesion-entre-un-rango-de-horas/

-------------
-------------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

-----------------

# Teor√≠a

## GPOs

### Directivas de Grupo (GPO) ‚Äì Filtrado de Seguridad
https://windowserver.wordpress.com/2017/07/11/directivas-de-grupo-gpo-filtrado-de-seguridad/

## Orden de aplicaci√≥n de las directivas
Tener en cuenta:
- M√°s abajo la √∫ltima que se ejecuta
- Administrador decide la aplicaci√≥n
Niveles de aplicaci√≥n:
- Sitio
- Dominio
- GPO

---------

# Pr√°ctica

## Tener en cuenta
 - IP
 - ping
 - EQUIPO EN DOMINIO
 - QUE SE VEA EN EL AD
 - CONFIGURAR LA DIRECTIVA
 - PROBARLO
 - gpupdate /force
 - GPRESULT /z

## Ejercicios de PowerShell
- Crear usuarios, carpetas NTFS y compartidas
  * https://www.jesusninoc.com/05/03/creacion-masiva-de-usuarios-en-el-directorio-activo-con-powershell-parte-1/
  * https://www.jesusninoc.com/05/09/creacion-masiva-de-usuarios-en-el-directorio-activo-con-powershell-parte-2/

- Crear usuarios en AD, carpeta compartida y asignar permisos
```PowerShell
  foreach($usuario in Get-Content .\usuarios.txt)
  {
      $usuario
      $password = (ConvertTo-SecureString "Alum4dos" -AsPlainText -force)
      New-ADUSer -Name $usuario -Sam $usuario -Path "OU=asir,DC=andel,DC=local" -AccountPassword $password -Enable $true
      $HomeDirectory = ("\\localhost\log\" + $usuario)
      mkdir $HomeDirectory
      $usuariomaspermiso = $usuario + ":F"
      $rutantfs = "C:\Users\Administrador\Desktop\log\" + $usuario
      icacls $rutantfs /grant $usuariomaspermiso
      Start-Sleep -Seconds 5
  }
```

## Configurar
- Directivas de grupo:
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n (REALIZAR UN LOG SI EL USUARIO ES usuario1 Y HA INICIADO SESI√ìN) (REALIZAR UN LOG SI EL USUARIO ES usuario1, HA INICIADO SESI√ìN ENTRE LAS 20:00 Y LAS 21:00)
- Directivas de grupo:
  - Redirecci√≥n de carpetas (CARPETA DOCUMENTOS REDIRECCIONADA A LA CARPETA COMPARTIDA) https://www.youtube.com/watch?v=hSALOgf7SwY
  - Orden de aplicaci√≥n de las directivas (CONFIGURAR GPOS PARA VER EL ORDEN)
  - Conjunto resultante de directivas (ANALIZAR EL CONJUNTO RESULTANTE DE DIRECTIVAS)
  - Especificar las opciones de seguridad 
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad

# Tarea sobre directivas
- MAPEAR DOS UNIDADES PARA UN USUARIO Y OCULTAR LAS UNIDADES LOCALES MEDIANTE GPO
- BLOQUEAR UNA APLICACI√ìN MEDIANTE GPO

-------------------
-------------------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

----------------------

# Tener en cuenta
 - IP
 - ping
 - EQUIPO EN DOMINIO
 - QUE SE VEA EN EL AD
 - CONFIGURAR LA DIRECTIVA
 - PROBARLO
 - gpupdate /force
 - GPRESULT /z

----------------------

# Algo de teor√≠a
## Manual del editor de GPO local en Windows 10
https://www.solvetic.com/tutoriales/article/2655-manual-del-editor-de-gpo-local-en-windows-10/

## How to Disable PowerShell with Software Restriction Policies GPO
https://www.top-password.com/blog/disable-powershell-with-software-restriction-policies-gpo

## Exportar informaci√≥n de una GPO (para ver referencia al registro)
https://www.jesusninoc.com/05/05/exportar-informacion-sobre-una-gpo-en-formato-xml/

-----------
-----------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

----------------------

# Directivas de grupo con PowerShell

## Configuraci√≥n gr√°fica de repaso
* https://github.com/jesusninoc/ClasesISO/blob/master/2020-05-07.md#tarea-sobre-directivas
* https://www.jesusninoc.com/07/05/5-gestion-del-software-en-powershell/
* https://docs.microsoft.com/en-us/powershell/module/applocker/Get-AppLockerPolicy?view=win10-ps

## Configurar con PowerShell
* https://sid-500.com/2017/08/25/configuring-group-policies-by-using-windows-powershell/

```PowerShell
Get-Command -Module GroupPolicy
New-GPO -Name "ScreenSaverTimeOut" -Comment "Sets the time to 900 seconds"
Set-GPRegistryValue -Name "ScreenSaverTimeOut" -Key "HKCU\Control Panel\Desktop" -ValueName ScreenSaveTimeOut -Type DWord -Value 900
New-GPLink -Name "ScreenSaverTimeOut" -Target "ou=people,dc=pagr,dc=inet"

Get-GPO -Name "ScreenSaverTimeOut" | Get-GPOReport -ReportType HTML -Path $Home\report.html
Invoke-Item $Home\report.html

# Configure Advanced Settings
## Inherited Group Policies
Get-GPInheritance -Target "ou=people,dc=pagr,dc=inet"

## Blocking inheritance
Set-GPInheritance -Target "ou=people,dc=pagr,dc=inet" -IsBlocked 1

## Enforcing Group Policies
Set-GPLink -Name "Default Domain Policy" -Target "dc=pagr,dc=inet" -Enforced Yes

## Configure Security Settings
Set-GPPermission -Name "ScreenSaverTimeOut" -TargetName "Authenticated Users" -TargetType User -PermissionLevel None
Set-GPPermission -Name "ScreenSaverTimeOut" -TargetName "Authenticated Users" -TargetType User -PermissionLevel GPORead
Set-GPPermission -Name "ScreenSaverTimeOut" -TargetName "Petra" -TargetType User -PermissionLevel GPOApply
```

----------------------

# Directivas de grupo

## Configurar
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas
  - No reemplazar
  
## Teor√≠a
- Bloquear herencia.
- Forzar una directiva: al haber forzado la aplicaci√≥n de la GPO, en este caso sobrepasar√° el bloqueo de herencia https://windowserver.wordpress.com/2017/07/11/directivas-de-grupo-gpo-herencia-forzado-y-resolucin-de-conflictos/.

## Pr√°ctica
```PowerShell
Get-GPO -Name "ScreenSaverTimeOut" | Get-GPOReport -ReportType HTML -Path $Home\report.html
Invoke-Item $Home\report.html

# Configure Advanced Settings
## Inherited Group Policies
Get-GPInheritance -Target "ou=people,dc=pagr,dc=inet"

## Blocking inheritance
Set-GPInheritance -Target "ou=people,dc=pagr,dc=inet" -IsBlocked 1

## Enforcing Group Policies
Set-GPLink -Name "Default Domain Policy" -Target "dc=pagr,dc=inet" -Enforced Yes
```

----------------------

# Directivas de grupo

## Configurar
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
  
## Teor√≠a
- Filtrado de seguridad (permisos) https://windowserver.wordpress.com/2017/07/11/directivas-de-grupo-gpo-filtrado-de-seguridad/

## Pr√°ctica
```PowerShell
# Configure Advanced Settings
## Configure Security Settings
Set-GPPermission -Name "ScreenSaverTimeOut" -TargetName "Authenticated Users" -TargetType User -PermissionLevel None
Set-GPPermission -Name "ScreenSaverTimeOut" -TargetName "Authenticated Users" -TargetType User -PermissionLevel GPORead
Set-GPPermission -Name "ScreenSaverTimeOut" -TargetName "Petra" -TargetType User -PermissionLevel GPOApply
```

--------------------------

# Pr√°ctica final de la asignatura: crear mediante scripts una estructura de una red con un dominio y las configuraciones de GPOS que necesites

## Ayuda
* https://www.jesusninoc.com/05/03/creacion-masiva-de-usuarios-en-el-directorio-activo-con-powershell-parte-1/
* https://www.jesusninoc.com/03/05/create-users-add-into-a-group-and-share-directory-with-permissions-in-active-directory/
* https://github.com/jesusninoc/ClasesISO/blob/master/2020-05-12.md#configurar-con-powershell

## Soluci√≥n del alumno Alejandro Aracil

```PowerShell
# Crear una Unidades Organizativas:
New-ADOrganizationalUnit -Name "ESO" -Path "dc=red,dc=local"
New-ADOrganizationalUnit -Name "1¬∫ESO" -Path "ou=ESO,dc=red,dc=local"
New-ADOrganizationalUnit -Name "2¬∫ESO" -Path "ou=ESO,dc=red,dc=local"
New-ADOrganizationalUnit -Name "3¬∫ESO" -Path "ou=ESO,dc=red,dc=local"
New-ADOrganizationalUnit -Name "4¬∫ESO" -Path "ou=ESO,dc=red,dc=local"
New-ADOrganizationalUnit -Name "Equipos" -Path "ou=ESO,dc=red,dc=local"

New-ADOrganizationalUnit -Name "BACH" -Path "dc=red,dc=local"
New-ADOrganizationalUnit -Name "1¬∫BACH" -Path "ou=BACH,dc=red,dc=local"
New-ADOrganizationalUnit -Name "2¬∫BACH" -Path "ou=BACH,dc=red,dc=local"
New-ADOrganizationalUnit -Name "Equipos" -Path "ou=BACH,dc=red,dc=local"

Start-Sleep -Seconds 1

# Crear GRUPOS A PARTIR DE UN FICHERO
gc Z:\GruposExamen.txt | %{
    New-ADGroup -name (($_).split(",")[0]) -GroupScope Global
}
Start-Sleep -Seconds 1

# Crear usuarios y meterlos en un grupo
gc Z:\UsuariosExamen.txt | %{
    new-aduser -name (($_).split(",")[0]) -sam (($_).split(",")[0]) -accountpassword (convertto-securestring "Retamar1a" -asplaintext -force) -enable $true
    Add-ADGroupMember (($_).split(",")[1]) -Members (($_).split(",")[0])
    }
Start-Sleep -Seconds 1

# Mover usuarios a una OU
Move-ADObject "cn=juan,cn=users,dc=red,dc=local" -TargetPath "ou=1¬∫ESO,ou=ESO,dc=red,dc=local"
Move-ADObject "cn=pedro,cn=users,dc=red,dc=local" -TargetPath "ou=1¬∫ESO,ou=ESO,dc=red,dc=local"
Move-ADObject "cn=lucia,cn=users,dc=red,dc=local" -TargetPath "ou=2¬∫BACH,ou=BACH,dc=red,dc=local"
Move-ADObject "cn=Pepito,cn=users,dc=red,dc=local" -TargetPath "ou=2¬∫BACH,ou=BACH,dc=red,dc=local"
Start-Sleep -Seconds 1

# Linkar GPOs
New-GPLink -name "QuitarCMD" -Target "ou=1¬∫ESO,ou=ESO,dc=red,dc=local" -Enforced Yes
New-GPLink -name "QuitarPanel" -Target "ou=1¬∫ESO,ou=ESO,dc=red,dc=local" -Enforced Yes
New-GPLink -name "FondoDeEscritorio" -Target "ou=Equipos,ou=ESO,dc=red,dc=local" -Enforced Yes

New-GPLink -name "QuitarCMD" -Target "ou=2¬∫BACH,ou=BACH,dc=red,dc=local" -Enforced Yes
New-GPLink -name "QuitarPanel" -Target "ou=2¬∫BACH,ou=BACH,dc=red,dc=local" -Enforced Yes
New-GPLink -name "FondoDeEscritorio" -Target "ou=Equipos,ou=BACH,dc=red,dc=local" -Enforced Yes
```

## Soluci√≥n con ejemplos de creaci√≥n de pol√≠ticas de grupo del alumno Ignacio Barranquero

```PowerShell
#Estructura, usuarios y pol√≠ticas del AD

#Unidades Organizativas

    #Equipos

    New-ADOrganizationalUnit -Name "Ordenadores Colegio" -Path "DC=red,DC=local"
    New-ADOrganizationalUnit -Name "LTI" -Path "OU=Ordenadores Colegio,DC=red,DC=local"
    New-ADOrganizationalUnit -Name "LTIALUMNOS" -Path "OU=LTI,OU=Ordenadores Colegio,DC=red,DC=local"
    New-ADOrganizationalUnit -Name "LTINOALUMNOS" -Path "OU=LTI,OU=Ordenadores Colegio,DC=red,DC=local"

    (1..3) | %{
        New-ADOrganizationalUnit -Name $_ -Path "OU=LTIALUMNOS,OU=LTI,OU=Ordenadores Colegio,DC=red,DC=local"
    }

    #Alumnos

    New-ADOrganizationalUnit -Name "Usuarios" -Path "DC=red,DC=local"
    New-ADOrganizationalUnit -Name "Alumnos" -Path "OU=Usuarios,DC=red,DC=local"

    Set-ADDefaultDomainPasswordPolicy -ComplexityEnabled $False -Identity red.local #Deshabilitar complejidad de contrase√±a

    Import-Csv C:\Users\Administrator\Desktop\alumnos.txt | %{
        
        $curso=$_.curso

        New-ADOrganizationalUnit -Name $curso -Path "OU=Alumnos,OU=Usuarios,DC=red,DC=local"

#Usuarios y grupos

        New-ADGroup -Name $curso -GroupScope DomainLocal -Path "OU=$curso,OU=Alumnos,OU=Usuarios,DC=red,DC=local"

        New-ADUser -Name $_.nombre -SamAccountName $_.nombre -DisplayName $_.nombre `
        -Enabled $true -ChangePasswordAtLogon $false -AccountPassword (ConvertTo-SecureString $_.password -AsPlainText -force) `
        -PassThru -UserPrincipalName $_.nombre -Path "OU=$curso,OU=Alumnos,OU=Usuarios,DC=red,DC=local"

        Add-ADGroupMember -Identity "CN=$curso,OU=$curso,OU=alumnos,OU=Usuarios,DC=red,DC=local" $_.nombre
    }


#Pol√≠ticas de grupo


#Deshabilitar Windows Defender

New-GPO -Name "Windows Defender" -Comment "Deshabilita Windows Defender Antivirus"
Set-GPRegistryValue -Name "Windows Defender" -Key "HKLM\Software\Policies\Microsoft\Windows Defender" -ValueName DisableAntiSpyware -Type DWord -Value 1
New-GPLink -Name "Windows Defender" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

#Deshabilitar Cortana

New-GPO -Name "Cortana" -Comment "Deshabilita las funciones de Cortana"
Set-GPRegistryValue -Name "Cortana" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search" -ValueName AllowCortana -Type DWord -Value 0
Set-GPRegistryValue -Name "Cortana" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search" -ValueName AllowCortanaAboveLock -Type DWord -Value 0
Set-GPRegistryValue -Name "Cortana" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search" -ValueName AllowSearchToUseLocation -Type DWord -Value 0
New-GPLink -Name "Cortana" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

#Deshabilitar animaci√≥n del primer inicio de sesi√≥n

New-GPO -Name "Animaci√≥n de inicio" -Comment "Deshabilita la animaci√≥n del primer inicio de sesi√≥n"
Set-GPRegistryValue -Name "Animaci√≥n de inicio" -Key "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -ValueName EnableFirstLogonAnimation -Type DWord -Value 0
New-GPLink -Name "Animaci√≥n de inicio" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

#Deshabilitar Firewall

New-GPO -Name "Firewall" -Comment "Deshabilita el Firewall"
Set-GPRegistryValue -Name "Firewall" -Key "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile" -ValueName EnableFirewall -Type DWord -Value 0
Set-GPRegistryValue -Name "Firewall" -Key "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\StandardProfile" -ValueName EnableFirewall -Type DWord -Value 0
New-GPLink -Name "Firewall" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

#Deshabilitar Notificaciones

New-GPO -Name "Notificaciones equipo" -Comment "Deshabilita las notificaciones"
Set-GPRegistryValue -Name "Notificaciones equipo" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender Security Center\Notifications" -ValueName DisableNotifications -Type DWord -Value 1
New-GPLink -Name "Notificaciones equipo" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

New-GPO -Name "Notificaciones usuario" -Comment "Deshabilita las notificaciones"
Set-GPRegistryValue -Name "Notificaciones usuario" -Key "HKCU\Software\Policies\Microsoft\Windows\CurrentVersion\PushNotifications" -ValueName NoToastApplicationNotification -Type DWord -Value 1
Set-GPRegistryValue -Name "Notificaciones usuario" -Key "HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" -ValueName TaskbarNoNotification -Type DWord -Value 1
Set-GPRegistryValue -Name "Notificaciones usuario" -Key "HKCU\Software\Policies\Microsoft\Windows\Explorer" -ValueName DisableNotificationCenter -Type DWord -Value 1
New-GPLink -Name "Notificaciones usuario" -Target "OU=Usuarios,DC=red,DC=local"
```

------------------
------------------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

---------------

# Pr√°ctica final de la asignatura: crear mediante scripts una estructura de una red con un dominio y las configuraciones de GPOS que necesites

## Ayuda
* https://www.jesusninoc.com/05/03/creacion-masiva-de-usuarios-en-el-directorio-activo-con-powershell-parte-1/
* https://www.jesusninoc.com/03/05/create-users-add-into-a-group-and-share-directory-with-permissions-in-active-directory/
* https://github.com/jesusninoc/ClasesISO/blob/master/2020-05-12.md#configurar-con-powershell

## Soluci√≥n del alumno Alejandro Aracil

```PowerShell
# Crear una Unidades Organizativas:
New-ADOrganizationalUnit -Name "ESO" -Path "dc=red,dc=local"
New-ADOrganizationalUnit -Name "1¬∫ESO" -Path "ou=ESO,dc=red,dc=local"
New-ADOrganizationalUnit -Name "2¬∫ESO" -Path "ou=ESO,dc=red,dc=local"
New-ADOrganizationalUnit -Name "3¬∫ESO" -Path "ou=ESO,dc=red,dc=local"
New-ADOrganizationalUnit -Name "4¬∫ESO" -Path "ou=ESO,dc=red,dc=local"
New-ADOrganizationalUnit -Name "Equipos" -Path "ou=ESO,dc=red,dc=local"

New-ADOrganizationalUnit -Name "BACH" -Path "dc=red,dc=local"
New-ADOrganizationalUnit -Name "1¬∫BACH" -Path "ou=BACH,dc=red,dc=local"
New-ADOrganizationalUnit -Name "2¬∫BACH" -Path "ou=BACH,dc=red,dc=local"
New-ADOrganizationalUnit -Name "Equipos" -Path "ou=BACH,dc=red,dc=local"

Start-Sleep -Seconds 1

# Crear GRUPOS A PARTIR DE UN FICHERO
gc Z:\GruposExamen.txt | %{
    New-ADGroup -name (($_).split(",")[0]) -GroupScope Global
}
Start-Sleep -Seconds 1

# Crear usuarios y meterlos en un grupo
gc Z:\UsuariosExamen.txt | %{
    new-aduser -name (($_).split(",")[0]) -sam (($_).split(",")[0]) -accountpassword (convertto-securestring "Retamar1a" -asplaintext -force) -enable $true
    Add-ADGroupMember (($_).split(",")[1]) -Members (($_).split(",")[0])
    }
Start-Sleep -Seconds 1

# Mover usuarios a una OU
Move-ADObject "cn=juan,cn=users,dc=red,dc=local" -TargetPath "ou=1¬∫ESO,ou=ESO,dc=red,dc=local"
Move-ADObject "cn=pedro,cn=users,dc=red,dc=local" -TargetPath "ou=1¬∫ESO,ou=ESO,dc=red,dc=local"
Move-ADObject "cn=lucia,cn=users,dc=red,dc=local" -TargetPath "ou=2¬∫BACH,ou=BACH,dc=red,dc=local"
Move-ADObject "cn=Pepito,cn=users,dc=red,dc=local" -TargetPath "ou=2¬∫BACH,ou=BACH,dc=red,dc=local"
Start-Sleep -Seconds 1

# Linkar GPOs
New-GPLink -name "QuitarCMD" -Target "ou=1¬∫ESO,ou=ESO,dc=red,dc=local" -Enforced Yes
New-GPLink -name "QuitarPanel" -Target "ou=1¬∫ESO,ou=ESO,dc=red,dc=local" -Enforced Yes
New-GPLink -name "FondoDeEscritorio" -Target "ou=Equipos,ou=ESO,dc=red,dc=local" -Enforced Yes

New-GPLink -name "QuitarCMD" -Target "ou=2¬∫BACH,ou=BACH,dc=red,dc=local" -Enforced Yes
New-GPLink -name "QuitarPanel" -Target "ou=2¬∫BACH,ou=BACH,dc=red,dc=local" -Enforced Yes
New-GPLink -name "FondoDeEscritorio" -Target "ou=Equipos,ou=BACH,dc=red,dc=local" -Enforced Yes
```

## Soluci√≥n con ejemplos de creaci√≥n de pol√≠ticas de grupo del alumno Ignacio Barranquero

```PowerShell
#Estructura, usuarios y pol√≠ticas del AD

#Unidades Organizativas

    #Equipos

    New-ADOrganizationalUnit -Name "Ordenadores Colegio" -Path "DC=red,DC=local"
    New-ADOrganizationalUnit -Name "LTI" -Path "OU=Ordenadores Colegio,DC=red,DC=local"
    New-ADOrganizationalUnit -Name "LTIALUMNOS" -Path "OU=LTI,OU=Ordenadores Colegio,DC=red,DC=local"
    New-ADOrganizationalUnit -Name "LTINOALUMNOS" -Path "OU=LTI,OU=Ordenadores Colegio,DC=red,DC=local"

    (1..3) | %{
        New-ADOrganizationalUnit -Name $_ -Path "OU=LTIALUMNOS,OU=LTI,OU=Ordenadores Colegio,DC=red,DC=local"
    }

    #Alumnos

    New-ADOrganizationalUnit -Name "Usuarios" -Path "DC=red,DC=local"
    New-ADOrganizationalUnit -Name "Alumnos" -Path "OU=Usuarios,DC=red,DC=local"

    Set-ADDefaultDomainPasswordPolicy -ComplexityEnabled $False -Identity red.local #Deshabilitar complejidad de contrase√±a

    Import-Csv C:\Users\Administrator\Desktop\alumnos.txt | %{
        
        $curso=$_.curso

        New-ADOrganizationalUnit -Name $curso -Path "OU=Alumnos,OU=Usuarios,DC=red,DC=local"

#Usuarios y grupos

        New-ADGroup -Name $curso -GroupScope DomainLocal -Path "OU=$curso,OU=Alumnos,OU=Usuarios,DC=red,DC=local"

        New-ADUser -Name $_.nombre -SamAccountName $_.nombre -DisplayName $_.nombre `
        -Enabled $true -ChangePasswordAtLogon $false -AccountPassword (ConvertTo-SecureString $_.password -AsPlainText -force) `
        -PassThru -UserPrincipalName $_.nombre -Path "OU=$curso,OU=Alumnos,OU=Usuarios,DC=red,DC=local"

        Add-ADGroupMember -Identity "CN=$curso,OU=$curso,OU=alumnos,OU=Usuarios,DC=red,DC=local" $_.nombre
    }


#Pol√≠ticas de grupo


#Deshabilitar Windows Defender

New-GPO -Name "Windows Defender" -Comment "Deshabilita Windows Defender Antivirus"
Set-GPRegistryValue -Name "Windows Defender" -Key "HKLM\Software\Policies\Microsoft\Windows Defender" -ValueName DisableAntiSpyware -Type DWord -Value 1
New-GPLink -Name "Windows Defender" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

#Deshabilitar Cortana

New-GPO -Name "Cortana" -Comment "Deshabilita las funciones de Cortana"
Set-GPRegistryValue -Name "Cortana" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search" -ValueName AllowCortana -Type DWord -Value 0
Set-GPRegistryValue -Name "Cortana" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search" -ValueName AllowCortanaAboveLock -Type DWord -Value 0
Set-GPRegistryValue -Name "Cortana" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search" -ValueName AllowSearchToUseLocation -Type DWord -Value 0
New-GPLink -Name "Cortana" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

#Deshabilitar animaci√≥n del primer inicio de sesi√≥n

New-GPO -Name "Animaci√≥n de inicio" -Comment "Deshabilita la animaci√≥n del primer inicio de sesi√≥n"
Set-GPRegistryValue -Name "Animaci√≥n de inicio" -Key "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -ValueName EnableFirstLogonAnimation -Type DWord -Value 0
New-GPLink -Name "Animaci√≥n de inicio" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

#Deshabilitar Firewall

New-GPO -Name "Firewall" -Comment "Deshabilita el Firewall"
Set-GPRegistryValue -Name "Firewall" -Key "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile" -ValueName EnableFirewall -Type DWord -Value 0
Set-GPRegistryValue -Name "Firewall" -Key "HKLM\SOFTWARE\Policies\Microsoft\WindowsFirewall\StandardProfile" -ValueName EnableFirewall -Type DWord -Value 0
New-GPLink -Name "Firewall" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

#Deshabilitar Notificaciones

New-GPO -Name "Notificaciones equipo" -Comment "Deshabilita las notificaciones"
Set-GPRegistryValue -Name "Notificaciones equipo" -Key "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender Security Center\Notifications" -ValueName DisableNotifications -Type DWord -Value 1
New-GPLink -Name "Notificaciones equipo" -Target "OU=Ordenadores Colegio,DC=red,DC=local"

New-GPO -Name "Notificaciones usuario" -Comment "Deshabilita las notificaciones"
Set-GPRegistryValue -Name "Notificaciones usuario" -Key "HKCU\Software\Policies\Microsoft\Windows\CurrentVersion\PushNotifications" -ValueName NoToastApplicationNotification -Type DWord -Value 1
Set-GPRegistryValue -Name "Notificaciones usuario" -Key "HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" -ValueName TaskbarNoNotification -Type DWord -Value 1
Set-GPRegistryValue -Name "Notificaciones usuario" -Key "HKCU\Software\Policies\Microsoft\Windows\Explorer" -ValueName DisableNotificationCenter -Type DWord -Value 1
New-GPLink -Name "Notificaciones usuario" -Target "OU=Usuarios,DC=red,DC=local"
```

-------------
-------------

# Linux (repaso)
* https://devdocs.io/bash/

## WSL
* https://www.jesusninoc.com/05/24/interoperabilidad-wsl-con-windows-llamar-a-powershell-desde-ubuntu/
* https://www.jesusninoc.com/12/07/crear-y-leer-un-codigo-de-barras-con-un-comando-en-bash-mediante-wsl-desde-powershell/
* https://www.jesusninoc.com/03/17/convertir-en-formato-json-un-objeto-de-powershell-y-despues-convertirlo-nuevamente-a-un-codigo-qr-mediante-un-comando-en-bash-con-wsl-comprobar-que-se-lee-correctamente-el-codigo-qr/

## Ejercicios heterog√©neos
* https://www.jesusninoc.com/03/27/ejercicios-de-bash-realizar-tareas-basicas-y-avanzadas/
* https://www.jesusninoc.com/node-js/
* https://www.jesusninoc.com/04/08/obtener-las-coordenadas-gps-mediante-adb/
* https://www.jesusninoc.com/03/25/ejecutar-google-chrome-en-android-mediante-adb-a-traves-de-powershell/
* https://www.jesusninoc.com/03/24/realizar-un-script-mezclando-python-y-powershell-que-detecte-las-coordenadas-de-un-texto-o-una-imagen-dentro-de-una-captura-de-pantalla-y-hacer-clic-en-dicha-posicion-hacerlo-de-forma-indefinida/
* https://ehmatthes.github.io/pcc/cheatsheets/README.html

------------
------------

# Directivas de seguridad y auditor√≠as:
- Requisitos de seguridad del sistema y de los datos.
- Derechos de usuario.
- Directivas de seguridad:
  - Locales
  - Del controlador de dominio
  - Del dominio.
- Directivas de grupo:
  - Administrar la directiva basada en el Registro con las plantillas administrativas.
  - Asignar secuencias de comandos al inicio/apagado del equipo y/o al inicio/cierre de sesi√≥n.
  - Redirecci√≥n de carpetas.
  - Administrar aplicaciones.
  - Especificar las opciones de seguridad.
- Orden de aplicaci√≥n de las directivas.
- Conjunto resultante de directivas.
- Filtrar la directiva en funci√≥n de la pertenencia a grupos de seguridad
- Opciones avanzadas en la aplicaci√≥n de las directivas:
  - Bloqueo de la herencia de directivas.
  - No reemplazar y deshabilitar.
- Registro del sistema operativo.
- Objetivos de la auditor√≠a.
- √Åmbito de la auditor√≠a. Aspectos auditables.
- Mecanismos de auditor√≠a. Alarmas y acciones correctivas.
- Informaci√≥n del registro de auditor√≠a.
- T√©cnicas y herramientas de auditor√≠a.
- Configurar la auditor√≠a: Auditar sucesos de inicio de sesi√≥n de cuenta, la administraci√≥n de cuentas, el acceso del servicio de directorio, sucesos de inicio de sesi√≥n, el acceso a objetos, el cambio de directivas, uso de privilegios, el seguimiento de procesos y sucesos del sistema.
- Informes de auditor√≠a.

--------------------------

# Saltar restricciones
* https://www.jesusninoc.com/04/24/ejecutar-la-calculadora-a-traves-de-explorer/
* https://www.jesusninoc.com/06/04/ejecutar-la-informacion-que-se-encuentra-en-un-valor-dentro-de-la-clave-clsid-del-registro-de-windows/
* https://www.jesusninoc.com/02/01/explicacion-sobre-el-uso-de-funciones-que-estan-en-dll-del-sistema-operativo-en-powershell/
* https://github.com/jesusninoc/ClasesISO/blob/master/2019-04-05.md

# Auditor√≠a

## Enumeraci√≥n FileSystemRights: Define los derechos de acceso que se utilizar√° al crear reglas de acceso y auditor√≠a
https://msdn.microsoft.com/es-es/library/system.security.accesscontrol.filesystemrights(v=vs.110).aspx
```PowerShell
[Enum]::GetNames([System.Security.AccessControl.FileSystemRights]) 
```

## Eventos
### 10. Gesti√≥n del rendimiento en PowerShell (nivel intermedio)
https://www.jesusninoc.com/07/10/10-gestion-del-rendimiento-en-powershell/
### EventLog
https://www.jesusninoc.com/eventlog/
### Saber qui√©n inici√≥ sesi√≥n en el sistema operativo de forma detallada analizando el registro de eventos de Windows (se requieren privilegios de administrador)
https://www.jesusninoc.com/07/23/saber-quien-inicio-sesion-en-el-sistema-operativo-de-forma-detallada-analizando-el-registro-de-eventos-de-windows-se-requieren-privilegios-de-administrador/
### Windows EVTX Samples [More than 160 EVTX examples]
https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES
### Crear eventos
* https://www.jesusninoc.com/05/04/escribir-y-ver-un-evento-en-el-registro-de-eventos-de-aplicacion/
* https://www.jesusninoc.com/02/16/registrar-y-mostrar-un-evento-en-powershell-cuando-se-crea-un-usuario/

## Auditor√≠a de proceso de l√≠nea de comandos
https://docs.microsoft.com/es-es/windows-server/identity/ad-ds/manage/component-updates/command-line-process-auditing
